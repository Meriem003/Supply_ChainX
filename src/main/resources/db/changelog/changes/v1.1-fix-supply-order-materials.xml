<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- ========================================
         CHANGESET 13: Fix supply_order_materials table
         Ajouter id et quantity pour correspondre à l'entité
         ======================================== -->
    <changeSet id="13" author="supplychainx">
        <!-- Étape 1: Supprimer les contraintes de clés étrangères -->
        <dropForeignKeyConstraint baseTableName="supply_order_materials" 
                                  constraintName="fk_supply_order_materials_order"/>
        <dropForeignKeyConstraint baseTableName="supply_order_materials" 
                                  constraintName="fk_supply_order_materials_material"/>
        
        <!-- Étape 2: Supprimer la clé primaire composite -->
        <dropPrimaryKey tableName="supply_order_materials"/>
        
        <!-- Étape 3: Ajouter la colonne id comme clé primaire -->
        <addColumn tableName="supply_order_materials">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
        </addColumn>
        
        <!-- Étape 4: Ajouter la colonne quantity -->
        <addColumn tableName="supply_order_materials">
            <column name="quantity" type="INT" defaultValue="1">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <!-- Étape 5: Ajouter une contrainte unique pour éviter les doublons -->
        <addUniqueConstraint tableName="supply_order_materials"
                           columnNames="supply_order_id, raw_material_id"
                           constraintName="uk_supply_order_materials"/>
        
        <!-- Étape 6: Recréer les contraintes de clés étrangères -->
        <addForeignKeyConstraint baseTableName="supply_order_materials"
                                baseColumnNames="supply_order_id"
                                constraintName="fk_supply_order_materials_order"
                                referencedTableName="supply_orders"
                                referencedColumnNames="id_order"
                                onDelete="CASCADE"/>
        
        <addForeignKeyConstraint baseTableName="supply_order_materials"
                                baseColumnNames="raw_material_id"
                                constraintName="fk_supply_order_materials_material"
                                referencedTableName="raw_materials"
                                referencedColumnNames="id_material"
                                onDelete="CASCADE"/>
        
        <rollback>
            <dropForeignKeyConstraint baseTableName="supply_order_materials" 
                                      constraintName="fk_supply_order_materials_order"/>
            <dropForeignKeyConstraint baseTableName="supply_order_materials" 
                                      constraintName="fk_supply_order_materials_material"/>
            <dropUniqueConstraint tableName="supply_order_materials" 
                                  constraintName="uk_supply_order_materials"/>
            <dropColumn tableName="supply_order_materials" columnName="quantity"/>
            <dropColumn tableName="supply_order_materials" columnName="id"/>
            <addPrimaryKey tableName="supply_order_materials" 
                          columnNames="supply_order_id, raw_material_id"/>
            <addForeignKeyConstraint baseTableName="supply_order_materials"
                                    baseColumnNames="supply_order_id"
                                    constraintName="fk_supply_order_materials_order"
                                    referencedTableName="supply_orders"
                                    referencedColumnNames="id_order"
                                    onDelete="CASCADE"/>
            <addForeignKeyConstraint baseTableName="supply_order_materials"
                                    baseColumnNames="raw_material_id"
                                    constraintName="fk_supply_order_materials_material"
                                    referencedTableName="raw_materials"
                                    referencedColumnNames="id_material"
                                    onDelete="CASCADE"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
